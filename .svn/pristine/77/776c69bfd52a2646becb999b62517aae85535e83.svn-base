package com.babpool.free.web;

import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.inject.Inject;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;
import javax.xml.ws.RespectBinding;

/*import org.slf4j.Logger;
*/import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import com.babpool.attach.dao.IAttachDao;
import com.babpool.attach.service.AttachServiceImpl;
import com.babpool.attach.service.IAttachService;
import com.babpool.attach.vo.AttachVO;
import com.babpool.common.util.StudyAttachUtils;
import com.babpool.common.valid.Modify;
import com.babpool.common.vo.PagingVO;
import com.babpool.common.vo.SearchVO;
import com.babpool.exception.BizAccessFailException;
import com.babpool.exception.BizNotEffectedException;
import com.babpool.exception.BizNotFoundException;
import com.babpool.free.dao.IFreeBoardDao;
import com.babpool.free.service.FreeBoardSeriveImpl;
import com.babpool.free.service.IFreeBoardService;
import com.babpool.free.vo.FreeBoardVO;
import com.babpool.member.vo.MemberVO;
import com.babpool.reply.dao.IReplyDao;
import com.babpool.reply.service.IReplyService;
import com.babpool.reply.vo.ReplySearchVO;
import com.babpool.reply.vo.ReplyVO;
import com.fasterxml.jackson.databind.ser.std.StdKeySerializers.Default;

/*import com.sun.org.slf4j.internal.LoggerFactory;
*/
@Controller
public class FreeBoardController {

	@Inject
	IFreeBoardDao freeBoardDao;

	@Inject
	IReplyService replyService;
	
	@Inject
	IReplyDao replyDao;

	@Inject
	IAttachDao attachDao;
	
	@Inject
	IAttachService attachService;
	
	@Inject
	IFreeBoardService freeBoardService;
	
	

	/*
	 * private static final com.sun.org.slf4j.internal.Logger LOGGER =
	 * LoggerFactory.getLogger(FreeBoardController.class);
	 */
	@RequestMapping("/free/freeBoardList.do")
	public String freeList(Model model, @ModelAttribute("searchVO") SearchVO searchVO) {
		int totalRowCount = freeBoardDao.getTotalRowCount(searchVO);
		searchVO.setTotalRowCount(totalRowCount);
		searchVO.pageSetting();

		List<FreeBoardVO> freeBoardList = freeBoardDao.getBoardList(searchVO);
		model.addAttribute("freeBoardList", freeBoardList);
		return "free/freeBoardList";

	}

	@RequestMapping(value = "/free/freeView.do", method = RequestMethod.GET)
	public String freeView(Model model, int freeBoardNo, ReplySearchVO searchVO) throws Exception {
		FreeBoardVO freeBoard = freeBoardDao.getFreeBoard(freeBoardNo);
		if (freeBoard == null) {
			throw new BizNotFoundException();
		}
		
		
		List<AttachVO> attaches = attachDao.getAttachListByParent(freeBoardNo, "FREE");
		freeBoard.setAttaches(attaches);
		
		model.addAttribute("freeBoard", freeBoard);
		searchVO.setReBoardNo(freeBoardNo);
		List<ReplyVO> replyList = replyService.getReplyListByParent(searchVO);
		model.addAttribute("replyList", replyList);
		

		return "free/freeView";

	}

	@RequestMapping("/free/freeEdit.do")
	public String freeEdit(Model model, int freeBoardNo) {
		FreeBoardVO freeBoard = freeBoardDao.getFreeBoard(freeBoardNo);
		model.addAttribute("freeBoard", freeBoard);

		return "free/freeEdit";
	}
	@Inject
	StudyAttachUtils studyAttachUils;
	
	@RequestMapping("/free/freeModify.do")
	public String freeModify(Model model,
			@ModelAttribute("freeBoard") @Validated(value = { Modify.class }) FreeBoardVO freeBoard,
			BindingResult error, @RequestParam(value = "boFiles", required = false) MultipartFile[] boFiles)
			throws IOException, BizNotFoundException {
		if (error.hasErrors()) {
			System.out.println("파일 수정에서 에러남");
		}
		
		try {
		
			System.out.println("바로켓 ::"+freeBoard.getAttaches());
			
			
		if (boFiles != null) {
			List<AttachVO> attaches = studyAttachUils.getAttachListByMultiparts(boFiles, "FREE", "free");
			// 실제로 파일경로에 선택된 파일 올리고 List<AttachVO> return (파일업로드)
			freeBoard.setAttaches(attaches);
			
		}
		System.out.println("수정성공");
		freeBoardService.modifyBoard(freeBoard);
		
		}catch(Exception e) {
			System.out.println("e"+e);
			System.out.println("수정 실패");

		}
		
		return "free/freeModify";
	}

	@RequestMapping("/free/freeDelete.do")
	public String freeDelete(Model model, @ModelAttribute("freeBoard") FreeBoardVO freeBoard) {
		freeBoardDao.deleteBoard(freeBoard);
		return "free/freeDelete";
	}

	@RequestMapping("/free/freeForm.do")
	public String freeeForm(Model model, @ModelAttribute("freeBoard") FreeBoardVO freeBoard) {
		return "free/freeForm";
	}



	@PostMapping("/free/freeRegist.do")
	public String freeRegist(Model model, @ModelAttribute("freeBoard") @Validated(Default.class) FreeBoardVO freeBoard,
			BindingResult error, @RequestParam(value = "boFiles", required = false) MultipartFile[] boFiles, HttpSession session)
			throws IOException, BizNotEffectedException {
		System.out.println("freeBoard"+freeBoard);
		MemberVO memberId = (MemberVO) session.getAttribute("member");
		
		if (error.hasErrors()) {
				System.out.println("파일등록 안되");
			}
			if(memberId != null) {
			try {
				if (boFiles != null) {
					List<AttachVO> attaches = studyAttachUils.getAttachListByMultiparts(boFiles, "FREE", "free");
					// 실제로 파일경로에 선택된 파일 올리고 List<AttachVO> return (파일업로드)
					freeBoard.setAttaches(attaches);
				}
				System.out.println(freeBoard);
				int cnt = freeBoardDao.insertBoard(freeBoard);
	
				if (cnt == 0)
					throw new BizNotEffectedException();
	
				List<AttachVO> attaches = freeBoard.getAttaches();
				System.out.println("attaches"+attaches);
				if (attaches != null) {
					for (AttachVO attach : attaches) {
						attach.setAtchParentNo(freeBoard.getFreeBoardNo());
						attachDao.insertAttach(attach);
					}
				}
				System.out.println("글 등록 성공");
			} catch (Exception e) {
				e.printStackTrace();
				System.out.println("글 등록 실패");
			}
	
			return "free/freeRegist";
		}else {
			System.out.println("글 등록 실패");
			return "login/loginPage";
		}
		
	}

	// 댓글 수정 GET
	@RequestMapping(value = "/replyUpdateView", method = RequestMethod.GET)
	public String replyUpdateView(ReplyVO vo, ReplySearchVO searchVO, Model model) throws Exception {
		/*
		 * ((Logger) LOGGER).info("reply Write");
		 */
		model.addAttribute("replyUpdate", replyService.selectReply(vo.getReNo()));
		model.addAttribute("searchVO", searchVO);

		return "free/replyUpdateView";
	}

	// 댓글 수정 POST
	@RequestMapping(value = "/replyUpdate", method = RequestMethod.POST)
	public String replyUpdate(ReplyVO vo, ReplySearchVO searchVO, RedirectAttributes rttr) throws Exception {
		/*
		 * ((Logger) LOGGER).info("reply Write");
		 */ replyService.updateReply(vo);

		rttr.addAttribute("bno", vo.getReBoardNo());
		rttr.addAttribute("CurPage", searchVO.getCurPage());
		rttr.addAttribute("PageSize", searchVO.getPageSize());
		rttr.addAttribute("FirstPage", searchVO.getFirstPage());

		return "redirect:/free/freeView";
	}

	// 댓글 삭제 GET
//	@RequestMapping(value = "/reply/replyDelete", method = RequestMethod.GET)
//	public String replyDeleteView(ReplyVO vo, ReplySearchVO searchVO, Model model) throws Exception {
//		/*
//		 * ((Logger) LOGGER).info("reply Write");
//		 */
//
//		model.addAttribute("replyDelete", replyService.selectReply(vo.getReBoardNo()));
//		model.addAttribute("searchVO", searchVO);
//
//		return "free/freeDelete";
//	}

	// 댓글 삭제
	@RequestMapping(value = "/reply/replyDelete.do", method = RequestMethod.POST)
	public String replyDelete(ReplyVO vo, ReplySearchVO searchVO, RedirectAttributes rttr) throws Exception {
		/*
		 * ((Logger) LOGGER).info("reply Write");
		 */
		System.out.println("===================================================================================================\n");
		System.out.println("replyvo::"+vo);
		replyDao.deleteReply(vo);

		rttr.addAttribute("bno", vo.getReBoardNo());
		rttr.addAttribute("CurPage", searchVO.getCurPage());
		rttr.addAttribute("PageSize", searchVO.getPageSize());
		rttr.addAttribute("FirstPage", searchVO.getFirstPage());

		return "redirect:/free/freeView";
	}

	@ResponseBody
	@RequestMapping(value = "/reply/replyList.do", produces = "application/json; charset=utf-8")
	public List<ReplyVO> replyList(ReplySearchVO searchVO) throws Exception {
		List<ReplyVO> replyList = replyService.getReplyListByParent(searchVO);
		System.out.println(replyList);
		Map<String, Object> map = new HashMap<String, Object>();
		map.put("result", true);
		map.put("data", replyList);
		map.put("size", replyList.size());

		return replyList;
	}

	@ResponseBody
	@RequestMapping(value = "/reply/replyRegist.do", produces = "application/json; charset=utf-8")
	public String replyRegist(ReplyVO reply, HttpSession session) throws Exception {
		MemberVO member = (MemberVO) session.getAttribute("member");
		
		if(member.getMemId() != null) {
			System.out.println("member::"+member);

			if (reply.getReSecret() == null) {
				reply.setReSecret("N");
			} else if (reply.getReSecret() != null) {
				reply.setReSecret("Y");
			}
			
		replyService.registReply(reply);
		System.out.println("등록 : " + reply);
//		map.put("result", true);
//		map.put("msg", "등록성공했어요");
		
		return "success";
		}else {
			System.out.println("member::"+member);
			return "false";		}
//		return map;
	}

	@ResponseBody
	@RequestMapping(value = "/reply/replyModify.do", produces = "application/json; charset=utf-8")
	public Map<String, Object> replyModify(ReplyVO reply) throws Exception {
		Map<String, Object> map = new HashMap<String, Object>();
		try {
			replyService.updateReply(reply);
			map.put("result", true);
			map.put("msg", "수정성공");
		} catch (BizAccessFailException e) {
			map.put("result", false);
			map.put("msg", "당신은 댓글을 쓴 사람이 아닙니다.");
		} catch (BizNotFoundException e) {
			map.put("result", false);
			map.put("msg", "댓글이 없습니다.");
		}
		return map;
	}

	@ResponseBody
	@RequestMapping(value = "/reply/replyDelete.do", produces = "application/json; charset=utf-8")
	public Map<String, Object> replyDelete(@ModelAttribute("reply") ReplyVO reply) throws Exception {
		Map<String, Object> map = new HashMap<String, Object>();
		System.out.println("reply/replyDelete.doreply/replyDelete.do:::"+reply);
		try {
			replyDao.deleteReply(reply);
			map.put("result", true);
			map.put("msg", "삭제성공");
		} catch (BizAccessFailException e) {
			map.put("result", false);
			map.put("msg", "당신은 댓글을 쓴 사람이 아닙니다.");
		} catch (BizNotFoundException e) {
			map.put("result", false);
			map.put("msg", "댓글이 없습니다.");
		}
		return map;
	}
}
